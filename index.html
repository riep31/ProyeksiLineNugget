<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Proyeksi Line Nuget</title>
  
  <!-- Grid.js CSS -->
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  
  <!-- Grid.js JS -->
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  
  <!-- XLSX untuk export Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Chart.js untuk Line Chart -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <style>
    body { 
      font-family:'Inter', 'Segoe UI', Tahoma, sans-serif; 
      margin:0; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height:100vh;
    }

    header {
      display:flex; 
      align-items:center; 
      justify-content:flex-start;
      background: linear-gradient(90deg, #f2f9ff 20%, #4949f5 100%);
      padding:20px 20px; 
      color:#2c3e50; 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
      gap: 40px;
      border-bottom: 1px solid rgba(52, 73, 94, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .logo { 
      display:flex; 
      align-items:center; 
      flex-shrink:0; 
    }
    
    .logo img { 
      width:110px; 
      height:55px; 
      margin-right:20px; 
      border-radius:12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    
    .logo img:hover {
      transform: scale(1.05);
    }
    
    .logo-text { 
      display:flex; 
      flex-direction:column; 
      line-height:1.3; 
    }
    
    .logo-text strong { 
      font-size:22px; 
      color:#2c3e50;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .logo-text span { 
      font-size:15px; 
      opacity:0.8; 
      color:#6c757d;
      font-weight: 400;
    }
    
    .controls { 
      display:flex; 
      gap:10px; 
      align-items:center; 
      flex-wrap:wrap; 
      margin-left: auto;
    }
    
    .status { 
      display:flex; 
      align-items:center; 
      font-size:12px; 
      margin-left:15px; 
    }
    
    .status span { 
      width:10px; 
      height:10px; 
      border-radius:50%; 
      display:inline-block; 
      margin-right:6px; 
    }
    
    .connected{background:#2ecc71;} 
    .disconnected{background:#e74c3c;} 
    .loading{background:#f1c40f;}

    .filters{
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      align-items:center;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      border-bottom: 2px solid rgba(52, 73, 94, 0.1);
      margin-bottom: 0;
    }
    
    .filters label {
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }
    
    select{
      padding:10px 15px;
      border-radius:8px;
      background: rgba(255, 255, 255, 0.9);
      border:2px solid rgba(52, 73, 94, 0.1);
      font-size:14px;
      min-width:180px;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 4px rgba(52,152,219,0.2);
      transform: translateY(-2px);
    }

    input[type="date"] {
      padding:10px 15px;
      border-radius:8px;
      background: rgba(255, 255, 255, 0.9);
      border:2px solid rgba(52, 73, 94, 0.1);
      font-size:14px;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    input[type="date"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 4px rgba(52,152,219,0.2);
      transform: translateY(-2px);
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0;
      margin: 0;
    }

    .action-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: #ffffff;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .action-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }

    .action-buttons button:active {
      transform: translateY(0);
    }

    #excelBtn {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    }

    #printBtn {
      background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
    }

    #resetBtn {
      background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
    }

    #toggleChartBtn {
      background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
    }

    /* ===========================
       CHART CONTAINER
       =========================== */
    .chart-container {
      margin: 0 10px 15px 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 21px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: none;
    }

    .chart-container.show {
      display: block;
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
      width: 100%;
    }

    /* ===========================
       TABLE CONTAINER
       =========================== */
    .table-container {
      margin: 0 10px 30px 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 21px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Grid.js Custom Styling - sama seperti Tabel 1 */
    .gridjs-container {
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      background: white;
      max-width: 100%;
      overflow: visible;
      height: auto;
      position: relative;
    }
    
    .gridjs-wrapper {
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: auto;
      position: relative;
    }

    table.gridjs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      table-layout: fixed;
    }

    thead.gridjs-thead {
      position: sticky;
      top: 0;
      z-index: 100;
    }

    thead.gridjs-thead th.gridjs-th {
      background-color: #1565c0 !important;
      color: white !important;
      font-weight: 700;
      text-align: center;
      white-space: nowrap !important;
      position: sticky;
      top: 0;
      z-index: 100;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: default !important;
      border: 1px solid #0d47a1 !important;
    }

    /* Tooltip pada header */
    thead.gridjs-thead th.gridjs-th:hover::after {
      content: attr(title);
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      z-index: 10;
      font-size: 10px;
      pointer-events: none;
    }

    tbody.gridjs-tbody tr:nth-child(even) td.gridjs-td {
      background-color: #e3f2fd !important;
    }

    tbody.gridjs-tbody tr:nth-child(odd) td.gridjs-td {
      background-color: #ffffff !important;
    }

    tbody.gridjs-tbody tr:hover td.gridjs-td {
      background-color: #c8e6c9 !important;
      transition: 0.2s;
    }

    td.gridjs-td {
      border: 1.5px solid #90a4ae !important;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
    }

    /* Scrollbar styling untuk gridjs-wrapper */
    .gridjs-wrapper::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .gridjs-wrapper::-webkit-scrollbar-track {
      background: rgba(52, 73, 94, 0.05);
      border-radius: 5px;
    }

    .gridjs-wrapper::-webkit-scrollbar-thumb {
      background: rgba(52, 73, 94, 0.3);
      border-radius: 5px;
    }

    .gridjs-wrapper::-webkit-scrollbar-thumb:hover {
      background: rgba(52, 73, 94, 0.5);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }
      
      select, input[type="date"] {
        min-width: 100%;
      }
      
      .controls {
        flex-wrap: wrap;
      }
      
      .logo-text strong {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="main" id="main">
    <header>
      <div class="logo">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU">
        <div class="logo-text">
          <strong>Proyeksi Line Nuget</strong>
          <span>Data Proyeksi Line Nuget</span>
        </div>
      </div>
      <div class="controls">
        <div id="dateTimeDisplay" style="font-size: 14px; font-weight: 600; color: #2c3e50; margin-right: 20px;"></div>
        <div class="status" id="status">
          <span class="disconnected"></span><span id="statusText">Disconnected</span>
        </div>
      </div>
    </header>

    <!-- Chart Container -->
    <div class="chart-container" id="chartContainer">
      <h3 style="margin-top: 0; color: #2c3e50; text-align: center;">üìà Line Chart - Data Kolom K, L, M</h3>
      <div class="chart-wrapper">
        <canvas id="lineChart"></canvas>
      </div>
    </div>

    <!-- Main Table with Filters Inside -->
    <div class="table-container">
      <!-- Filters -->
      <div class="filters">
        <label for="filterBMulai">Tanggal Mulai:</label>
        <input type="date" id="filterBMulai">

        <label for="filterBSelesai">Tanggal Selesai:</label>
        <input type="date" id="filterBSelesai">

        <label for="filterG">Nama Sampel:</label>
        <select id="filterG">
          <option value="">Semua</option>
        </select>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button id="toggleChartBtn">üìä Tampilkan Chart</button>
          <button id="excelBtn">üì• Excel</button>
          <button id="printBtn">üñ®Ô∏è Print</button>
          <button id="resetBtn">üîÑ Reset</button>
        </div>
      </div>

      <div id="gridTable"></div>
    </div>
  </div>

<script>
// Google Sheets API Configuration
let apiKey = 'AIzaSyD3nhZyvd7npQw6n9mPXxOA6svJdo_JQis';
let spreadsheetId = '1ngP7PTE4mNKtkcTQU5sRYswdYmdC401M4ioxxkt-Hxw';
let sheetName = 'PROYEKSI_LINE_NUGET';

let allRows = [];
let currentData = [];
let grid;
let headers = [];
let myChart = null;

// Google Sheets API function to fetch data
async function fetchSheetData(sheetNameParam) {
  if (!apiKey || !spreadsheetId) {
    throw new Error('API key or spreadsheet ID not configured');
  }
  
  const range = `${sheetNameParam}!A:Z`;
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
  
  const response = await fetch(url);
  
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`Google Sheets API Error: ${errorData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  return data.values || [];
}

// Fungsi untuk format tanggal dari Google Sheets (DD/MM/YYYY)
function formatDateFromGoogleSheets(dateStr) {
  if (!dateStr) return '';
  
  dateStr = dateStr.toString().trim();
  
  // Jika sudah dalam format DD/MM/YYYY, kembalikan dengan padding
  const slashPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
  const match = dateStr.match(slashPattern);
  
  if (match) {
    const day = match[1].padStart(2, '0');
    const month = match[2].padStart(2, '0');
    const year = match[3];
    
    return `${day}/${month}/${year}`;
  }
  
  return dateStr;
}

// Convert DD/MM/YYYY to YYYY-MM-DD for date input
function convertToDateInputFormat(dateStr) {
  if (!dateStr) return '';
  const match = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (match) {
    return `${match[3]}-${match[2]}-${match[1]}`;
  }
  return '';
}

// Convert YYYY-MM-DD to DD/MM/YYYY
function convertFromDateInputFormat(dateStr) {
  if (!dateStr) return '';
  const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (match) {
    return `${match[3]}/${match[2]}/${match[1]}`;
  }
  return '';
}

// Compare dates in DD/MM/YYYY format
function compareDates(date1, date2, operator) {
  const d1Match = date1.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  const d2Match = date2.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  
  if (!d1Match || !d2Match) return false;
  
  const num1 = parseInt(d1Match[3] + d1Match[2] + d1Match[1]);
  const num2 = parseInt(d2Match[3] + d2Match[2] + d2Match[1]);
  
  if (operator === '>=') return num1 >= num2;
  if (operator === '<=') return num1 <= num2;
  return false;
}

// Fungsi tooltip untuk header
function applyHeaderTooltip() {
  document.querySelectorAll('.gridjs-thead .gridjs-th').forEach(th => {
    th.setAttribute('title', th.textContent.trim());
    th.style.position = 'sticky';
    th.style.top = '0';
  });
}

async function loadSheet(){
  if (!apiKey || apiKey === 'YOUR_API_KEY_HERE') {
    setStatus("disconnected", "API Key belum dikonfigurasi");
    return;
  }
  
  setStatus("loading","Loading...");
  try{
    const mainSheetData = await fetchSheetData(sheetName);
    
    if (mainSheetData.length === 0) {
      setStatus("disconnected", "Tidak ada data");
      return;
    }
    
    // Ambil header
    headers = mainSheetData[0];
    
    // Ambil dan filter data (skip row kosong)
    allRows = mainSheetData.slice(1).filter(row => {
      return row.some(cell => cell && cell.toString().trim() !== '');
    });
    
    // Format tanggal untuk kolom A (index 0) dan B (index 1)
    allRows = allRows.map(row => {
      return row.map((cell, i) => {
        if ((i === 0 || i === 1) && cell) {
          return formatDateFromGoogleSheets(cell);
        }
        return cell || '';
      });
    });
    
    currentData = [...allRows];
    
    console.log('Total rows valid:', allRows.length);
    
    renderGrid();
    fillFilters();
    // JANGAN update chart di sini, biarkan kosong sampai user klik tombol chart
    
    setStatus("connected","Connected");
  } catch(error) {
    console.error('Error loading sheet:', error);
    setStatus("disconnected","Error: " + error.message);
  }
}

function renderGrid() {
  // Render Grid.js
  grid = new gridjs.Grid({
    columns: headers.map(h => ({ name: h, sort: false })),
    data: currentData,
    pagination: { limit: 25, summary: true },
    search: true,
    sort: false,
    resizable: true,
    autoWidth: true,
    language: {
      search: {
        placeholder: 'üîç Cari data...'
      },
      pagination: {
        previous: 'Sebelumnya',
        next: 'Selanjutnya',
        showing: 'Menampilkan',
        results: () => 'data',
        of: 'dari',
        to: 'sampai'
      }
    }
  }).render(document.getElementById("gridTable"));

  setTimeout(applyHeaderTooltip, 1000);
}

function applyFilters(){
  const fBMulai = document.getElementById("filterBMulai").value;
  const fBSelesai = document.getElementById("filterBSelesai").value;
  const fG = document.getElementById("filterG").value;
  
  const tglMulai = convertFromDateInputFormat(fBMulai);
  const tglSelesai = convertFromDateInputFormat(fBSelesai);
  
  console.log('Filter - Tanggal Mulai:', tglMulai);
  console.log('Filter - Tanggal Selesai:', tglSelesai);
  console.log('Filter - Nama Sampel:', fG);
  
  currentData = allRows.filter(row => {
    // Filter tanggal range
    let cocokTanggal = true;
    if (tglMulai && row[1]) {
      cocokTanggal = cocokTanggal && compareDates(row[1], tglMulai, '>=');
    }
    if (tglSelesai && row[1]) {
      cocokTanggal = cocokTanggal && compareDates(row[1], tglSelesai, '<=');
    }
    
    // Filter nama sampel
    const cocokSampel = !fG || row[6] === fG;
    
    return cocokTanggal && cocokSampel;
  });
  
  console.log('Data setelah filter:', currentData.length, 'rows');
  console.log('Sample filtered dates:', currentData.slice(0, 5).map(r => r[1]));
  
  // Update grid
  grid.updateConfig({ data: currentData }).forceRender().then(() => {
    applyHeaderTooltip();
  });
  
  // Update chart dengan data terfilter
  updateChart();
}

function fillFilters(){
  if (allRows.length === 0) return;
  
  // Fill filter for column G (index 6) - Nama Sampel
  let sG = document.getElementById("filterG");
  sG.innerHTML = "<option value=''>Semua</option>";
  let valsG = [...new Set(allRows.map(r => r[6]))].filter(v => v);
  valsG.sort();
  valsG.forEach(v => {
    let o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sG.appendChild(o);
  });
}

function updateChart() {
  // Pastikan chart container sudah ada
  const chartCanvas = document.getElementById('lineChart');
  if (!chartCanvas) {
    console.error('Chart canvas not found');
    return;
  }
  
  // Cek apakah ada data
  if (!currentData || currentData.length === 0) {
    console.warn('No data available for chart');
    // Destroy chart jika tidak ada data
    if (myChart) {
      myChart.destroy();
      myChart = null;
    }
    return;
  }
  
  // Ambil data dari kolom K (index 10), L (index 11), M (index 12)
  // GUNAKAN currentData yang sudah terfilter, bukan allRows
  const labels = currentData.map(row => row[1] || ''); // Tanggal OKP sebagai label
  const dataK = currentData.map(row => {
    const val = parseFloat(row[10]);
    return isNaN(val) ? 0 : val;
  });
  const dataL = currentData.map(row => {
    const val = parseFloat(row[11]);
    return isNaN(val) ? 0 : val;
  });
  const dataM = currentData.map(row => {
    const val = parseFloat(row[12]);
    return isNaN(val) ? 0 : val;
  });
  
  console.log('Chart Update - Data Length:', currentData.length);
  console.log('Chart Update - Labels:', labels.slice(0, 5));
  console.log('Chart Update - Sample K:', dataK.slice(0, 5));
  console.log('Chart Update - Sample L:', dataL.slice(0, 5));
  console.log('Chart Update - Sample M:', dataM.slice(0, 5));
  
  const ctx = chartCanvas.getContext('2d');
  
  // Destroy chart lama jika ada
  if (myChart) {
    myChart.destroy();
    myChart = null;
  }
  
  // Buat chart baru dengan data yang sudah difilter
  myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: headers[10] || 'Kolom K',
          data: dataK,
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.1)',
          tension: 0.4,
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: false
        },
        {
          label: headers[11] || 'Kolom L',
          data: dataL,
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          tension: 0.4,
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: false
        },
        {
          label: headers[12] || 'Kolom M',
          data: dataM,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          tension: 0.4,
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
        title: {
          display: false
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
  
  console.log('Chart created successfully');
}

function updateDateTime() {
  const now = new Date();
  
  const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
  const monthNames = [
    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
  ];
  
  const dayName = dayNames[now.getDay()];
  const day = now.getDate();
  const month = monthNames[now.getMonth()];
  const year = now.getFullYear();
  
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  
  const dateTimeString = `üìÖ ${dayName}, ${day} ${month} ${year} | ‚è∞ ${hours}:${minutes}:${seconds}`;
  
  document.getElementById('dateTimeDisplay').innerHTML = dateTimeString;
}

function setStatus(st, t){ 
  let span = document.querySelector("#status span"); 
  span.className = st === "connected" ? "connected" : st === "loading" ? "loading" : "disconnected"; 
  document.getElementById("statusText").textContent = t; 
}

// Toggle chart visibility
document.getElementById("toggleChartBtn").addEventListener("click", () => {
  const chartContainer = document.getElementById("chartContainer");
  const btn = document.getElementById("toggleChartBtn");
  
  if (chartContainer.classList.contains("show")) {
    chartContainer.classList.remove("show");
    btn.textContent = "üìä Tampilkan Chart";
  } else {
    chartContainer.classList.add("show");
    btn.textContent = "üìä Sembunyikan Chart";
    // Update chart saat ditampilkan dengan data currentData yang terfilter
    updateChart();
    setTimeout(() => {
      if (myChart) {
        myChart.resize();
      }
    }, 100);
  }
});

// Event listeners untuk filter
document.getElementById("filterBMulai").addEventListener("change", applyFilters);
document.getElementById("filterBSelesai").addEventListener("change", applyFilters);
document.getElementById("filterG").addEventListener("change", applyFilters);

document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("filterBMulai").value = '';
  document.getElementById("filterBSelesai").value = '';
  document.getElementById("filterG").value = '';
  currentData = [...allRows];
  grid.updateConfig({ data: allRows }).forceRender().then(() => {
    applyHeaderTooltip();
  });
  updateChart();
});

// Export Excel
document.getElementById('excelBtn').addEventListener('click', () => {
  const tableData = [headers, ...currentData];
  const worksheet = XLSX.utils.aoa_to_sheet(tableData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "ProyeksiLineNuget");
  XLSX.writeFile(workbook, "Proyeksi_Line_Nuget.xlsx");
});

// Print
document.getElementById('printBtn').addEventListener('click', () => {
  const visibleRows = document.querySelectorAll(".gridjs-tbody tr");
  if (visibleRows.length === 0) {
    alert("Tidak ada data yang ditampilkan untuk dicetak.");
    return;
  }

  const tableHtml = `
    <table border="1" cellspacing="0" cellpadding="5">
      <thead>
        <tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${Array.from(visibleRows).map(tr => `<tr>${tr.innerHTML}</tr>`).join("")}
      </tbody>
    </table>
  `;

  const newWin = window.open("");
  newWin.document.write(`
    <html>
      <head>
        <title>Cetak Proyeksi Line Nuget</title>
        <style>
          table {border-collapse: collapse; width: 100%; font-size: 12px;}
          th, td {border: 1px solid #999; padding: 6px; text-align: left;}
          th {background: #1565c0; color: white;}
          h3 {text-align: center;}
        </style>
      </head>
      <body>
        <h3>Proyeksi Line Nuget - Data Terfilter (Halaman Aktif)</h3>
        ${tableHtml}
        <script>window.print();<\/script>
      </body>
    </html>
  `);
  newWin.document.close();
});

// Initialize
updateDateTime();
setInterval(updateDateTime, 1000);
loadSheet();
</script>
</body>
</html>
